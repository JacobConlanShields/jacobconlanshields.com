<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Relative Momentum — Jacob Conlon Shields</title>
  <link rel="stylesheet" href="/assets/styles.css" />
  <style>
    body {
      font-size: 15px;
    }

    h1 {
      margin-bottom: 4px;
    }

    .viewer-intro {
      margin-top: 4px;
      margin-bottom: 6px;
    }

    .viewer {
      margin-top: 6px;
      display: grid;
      gap: 6px;
      --page-max-height: 460px;
    }

    .viewer-controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-bottom: 0;
    }

    .viewer-controls .btn {
      min-width: 120px;
      text-align: center;
    }

    .viewer-controls .icon-btn {
      min-width: auto;
    }

    .buy-row {
      position: relative;
      z-index: 5;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 4px;
      margin-bottom: 2px;
    }

    .buy-row .btn {
      margin: 0;
    }

    .loading-indicator {
      font-size: 0.95rem;
      opacity: 0.8;
      min-height: 1.2em;
    }

    .spread {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      align-items: center;
      transition: opacity 220ms ease, transform 220ms ease;
      position: relative;
      z-index: 1;
      margin-top: 2px;
      perspective: 1200px;
    }

    .spread.turning {
      opacity: 0.2;
      transform: translateX(12px);
    }

    .page-frame {
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(0, 0, 0, 0.2);
      padding: 6px;
      border-radius: 10px;
      min-height: 220px;
      max-height: var(--page-max-height, min(70vh, 680px));
      height: var(--page-max-height, min(70vh, 680px));
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: zoom-in;

    }

    .viewer.zoomed .page-frame {
      border-radius: 14px;
    }

    .viewer.zoomed .page-frame,
    .fullscreen-viewer.zoomed .page-frame {
      cursor: zoom-out;
    }

    .fullscreen-viewer.zoomed .page-frame {
      padding: 4px;
    }

    .fullscreen-viewer.zoomed .spread {
      gap: 10px;
    }

    .page-sheet {
      width: 100%;
      height: 100%;
      border-radius: 8px;
      overflow: hidden;
      background: rgba(10, 10, 10, 0.45);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.04);
      transform-origin: left center;
      will-change: transform;
    }

    .spread.turning[data-direction="forward"] .page-sheet {
      animation: pageTurnForward 420ms ease;
    }

    .spread.turning[data-direction="backward"] .page-sheet {
      animation: pageTurnBackward 420ms ease;
    }

    @keyframes pageTurnForward {
      0% {
        transform: rotateY(0deg);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.06),
          0 0 0 rgba(0, 0, 0, 0);
      }
      45% {
        transform: rotateY(-12deg);
        box-shadow: inset -40px 0 45px rgba(0, 0, 0, 0.45);
      }
      100% {
        transform: rotateY(0deg);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.06),
          0 0 0 rgba(0, 0, 0, 0);
      }
    }

    @keyframes pageTurnBackward {
      0% {
        transform: rotateY(0deg);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.06),
          0 0 0 rgba(0, 0, 0, 0);
      }
      45% {
        transform: rotateY(12deg);
        box-shadow: inset 40px 0 45px rgba(0, 0, 0, 0.45);
      }
      100% {
        transform: rotateY(0deg);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.06),
          0 0 0 rgba(0, 0, 0, 0);
      }
    }

    .page-frame img {
      width: 100%;
      height: auto;
      max-height: 100%;
      object-fit: contain;
      display: block;
      border-radius: 6px;
    }

    .missing-page {
      font-size: 0.95rem;
      text-align: center;
      opacity: 0.7;
      padding: 12px;
    }

    .progress-wrap {
      margin-top: 10px;
    }

    .progress-slider {
      width: 100%;
      appearance: none;
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(
        to right,
        rgba(255, 255, 255, 0.85) 0%,
        rgba(255, 255, 255, 0.85) var(--progress, 0%),
        rgba(255, 255, 255, 0.15) var(--progress, 0%),
        rgba(255, 255, 255, 0.15) 100%
      );
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .progress-slider::-webkit-slider-thumb {
      appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.85);
      border: 2px solid rgba(0, 0, 0, 0.3);
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    .progress-slider::-moz-range-thumb {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.85);
      border: 2px solid rgba(0, 0, 0, 0.3);
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    .fullscreen-modal .modal-card {
      width: min(1200px, 96vw);
      margin: 2.5vh auto 0;
      padding: 16px;
      max-height: 94vh;
      display: flex;
      flex-direction: column;
    }

    .fullscreen-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 8px;
    }

    .fullscreen-header h2 {
      font-size: 1.1rem;
      margin: 0;
    }

    .fullscreen-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 4px;
    }

    .fullscreen-viewer .spread {
      margin-top: 2px;
    }

    .fullscreen-viewer {
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .fullscreen-viewer .spread {
      flex: 1;
    }

    .fullscreen-viewer .progress-wrap {
      margin-top: 4px;
      padding-bottom: 6px;
    }

    @media (max-width: 899px) {
      body {
        font-size: 13px;
      }

      .spread {
        grid-template-columns: 1fr;
      }

      .viewer {
        --page-max-height: 380px;
      }
    }
  </style>
</head>

<body>
  <main>
    <p class="nav">
      <a href="/">Home</a>
      <span class="dot">•</span>
      <a href="/pages/writing/">Writing</a>
      <span class="dot">•</span>
      <a href="/contact/">Contact</a>
    </p>

    <hr class="tight-hr">

    <h1>Relative Momentum</h1>
    <p class="viewer-intro">
      A two-page spread view of the ebook. Use the buttons, arrow keys, or a
      scroll gesture to move through the pages.
    </p>

    <div class="buy-row">
      <a class="btn"
         href="https://a.co/d/fbTRmg4"
         target="_blank" rel="noopener noreferrer">
        Buy on Amazon
      </a>
      <div class="viewer-controls" role="group" aria-label="Page navigation">
        <button class="icon-btn" type="button" id="prev-button" aria-label="Previous pages" title="Previous pages">◀</button>
        <button class="icon-btn" type="button" id="next-button" aria-label="Next pages" title="Next pages">▶</button>
        <button class="icon-btn" type="button" id="fullscreen-button" aria-label="Open full screen viewer" title="Full screen">⛶</button>
      </div>
    </div>

    <section class="viewer" aria-label="Relative Momentum ebook viewer">

      <div class="loading-indicator" id="loading-indicator" aria-live="polite"></div>

      <div class="spread" id="spread"></div>

      <div class="progress-wrap" aria-label="Reading progress">
        <input class="progress-slider" id="progress-slider" type="range" min="1" max="112" value="1" aria-label="Reading progress slider" />
      </div>
    </section>

    <div class="modal fullscreen-modal" id="fullscreen-modal" aria-hidden="true">
      <div class="modal-backdrop" data-close="fullscreen"></div>
      <div class="modal-card" role="dialog" aria-modal="true" aria-label="Full screen reader">
        <div class="fullscreen-header">
          <h2>Relative Momentum — Full Screen</h2>
          <button class="modal-close" type="button" data-close="fullscreen" aria-label="Close full screen">✕</button>
        </div>
        <div class="fullscreen-controls" role="group" aria-label="Full screen page navigation">
          <button class="icon-btn" type="button" id="fullscreen-prev" aria-label="Previous pages" title="Previous pages">◀</button>
          <button class="icon-btn" type="button" id="fullscreen-next" aria-label="Next pages" title="Next pages">▶</button>
        </div>
        <section class="viewer fullscreen-viewer" aria-label="Full screen Relative Momentum ebook viewer">
          <div class="loading-indicator" id="fullscreen-loading" aria-live="polite"></div>
          <div class="spread" id="fullscreen-spread"></div>
          <div class="progress-wrap" aria-label="Reading progress">
            <input class="progress-slider" id="fullscreen-progress" type="range" min="1" max="112" value="1" aria-label="Reading progress slider" />
          </div>
        </section>
      </div>
    </div>
  </main>

  <script>
    const TOTAL_PAGES = 112;
    const IMAGE_BASE = "https://pub-7efa5866e0ab41af9e691f0820376dfc.r2.dev/pages/";

    const spread = document.getElementById("spread");
    const fullscreenSpread = document.getElementById("fullscreen-spread");
    const loadingIndicator = document.getElementById("loading-indicator");
    const fullscreenLoading = document.getElementById("fullscreen-loading");
    const prevButton = document.getElementById("prev-button");
    const nextButton = document.getElementById("next-button");
    const fullscreenButton = document.getElementById("fullscreen-button");
    const fullscreenModal = document.getElementById("fullscreen-modal");
    const fullscreenPrev = document.getElementById("fullscreen-prev");
    const fullscreenNext = document.getElementById("fullscreen-next");
    const progressSlider = document.getElementById("progress-slider");
    const fullscreenProgress = document.getElementById("fullscreen-progress");

    const mobileQuery = window.matchMedia("(max-width: 899px)");
    const viewer = document.querySelector(".viewer");
    const fullscreenViewer = document.querySelector(".fullscreen-viewer");
    let currentPage = 1;
    let lastWheelTime = 0;
    let lastDirection = "forward";
    let isZoomedMain = false;
    let isZoomedFullscreen = false;

    const clampPage = (page) => Math.min(Math.max(page, 1), TOTAL_PAGES);

    const isMobile = () => mobileQuery.matches;

    const snapToSpreadStart = (page) => {
      if (isZoomedMain && !fullscreenModal.classList.contains("open")) {
        return clampPage(page);
      }
      if (isMobile()) {
        return clampPage(page);
      }
      const snapped = page % 2 === 0 ? page - 1 : page;
      return clampPage(snapped);
    };

    const updateHash = (page) => {
      const newHash = `#p=${page}`;
      if (window.location.hash !== newHash) {
        window.location.hash = newHash;
      }
    };

    const parseHash = () => {
      const match = window.location.hash.match(/p=(\d+)/);
      if (!match) return 1;
      return clampPage(parseInt(match[1], 10));
    };

    const formatPageNumber = (page) => page.toString().padStart(3, "0");

    const setLoadingFor = (targetIndicator, isLoading, message = "Loading pages…") => {
      if (!targetIndicator) return;
      targetIndicator.textContent = isLoading ? message : "";
    };

    const updatePageMaxHeight = (targetViewer, targetSpread, isZoomed) => {
      if (!targetViewer || !targetSpread) return;
      const spreadTop = targetSpread.getBoundingClientRect().top;
      const viewportPadding = 24;
      const available = window.innerHeight - spreadTop - viewportPadding;
      const minHeight = isMobile() ? 220 : 260;
      const maxHeight = isMobile() ? 460 : isZoomed ? available : 560;
      const nextHeight = Math.max(minHeight, Math.min(available, maxHeight));
      targetViewer.style.setProperty("--page-max-height", `${nextHeight}px`);
    };

    const preloadNext = (page) => {
      const pagesToLoad = isMobile() ? [page + 1] : [page + 2, page + 3];
      pagesToLoad
        .map(clampPage)
        .filter((p) => p > 0 && p <= TOTAL_PAGES)
        .forEach((p) => {
          const img = new Image();
          img.src = `${IMAGE_BASE}page-${formatPageNumber(p)}.jpg`;
        });
    };

    const createPageFrame = (page) => {
      const frame = document.createElement("div");
      frame.className = "page-frame";
      frame.dataset.page = page;
      const sheet = document.createElement("div");
      sheet.className = "page-sheet";

      if (page > TOTAL_PAGES || page < 1) {
        frame.dataset.page = "";
        frame.appendChild(sheet);
        return frame;
      }

      const img = document.createElement("img");
      img.loading = "lazy";
      img.alt = `Relative Momentum page ${page}`;
      img.src = `${IMAGE_BASE}page-${formatPageNumber(page)}.jpg`;

      img.addEventListener("error", () => {
        sheet.innerHTML = "";
        const missing = document.createElement("div");
        missing.className = "missing-page";
        missing.textContent = `Page ${page} is unavailable.`;
        sheet.appendChild(missing);
      });

      sheet.appendChild(img);
      frame.appendChild(sheet);
      return frame;
    };

    const renderPages = (page, targetSpread, targetViewer, targetIndicator, zoomMode) => {
      targetSpread.classList.add("turning");
      targetSpread.dataset.direction = lastDirection;
      setLoadingFor(targetIndicator, true);
      updatePageMaxHeight(targetViewer, targetSpread, zoomMode);
      targetSpread.innerHTML = "";

      const shouldSingle = zoomMode && targetViewer === viewer;
      const pages = (shouldSingle || isMobile()) ? [page] : [page, page + 1];
      const frames = pages.map(createPageFrame);
      frames.forEach((frame) => targetSpread.appendChild(frame));

      const images = Array.from(targetSpread.querySelectorAll("img"));
      const onImageDone = () => {
        const allDone = images.every((img) => img.complete);
        if (allDone) {
          setLoadingFor(targetIndicator, false);
        }
      };

      if (images.length === 0) {
        setLoadingFor(targetIndicator, false, "No pages to display.");
      } else {
        images.forEach((img) => {
          if (img.complete) {
            onImageDone();
          } else {
            img.addEventListener("load", onImageDone, { once: true });
            img.addEventListener("error", onImageDone, { once: true });
          }
        });
      }

      window.setTimeout(() => targetSpread.classList.remove("turning"), 420);
      preloadNext(page);
    };

    const updateProgress = () => {
      const progress = ((currentPage - 1) / (TOTAL_PAGES - 1)) * 100;
      [progressSlider, fullscreenProgress].forEach((slider) => {
        if (!slider) return;
        slider.value = currentPage;
        slider.style.setProperty("--progress", `${progress}%`);
      });
    };

    const updateZoomState = () => {
      if (viewer) {
        viewer.classList.toggle("zoomed", isZoomedMain);
      }
      if (fullscreenViewer) {
        fullscreenViewer.classList.toggle("zoomed", isZoomedFullscreen);
      }
    };

    const currentStep = () => {
      if (isMobile()) return 1;
      if (fullscreenModal.classList.contains("open")) return 2;
      return isZoomedMain ? 1 : 2;
    };

    const goToPage = (page) => {
      const target = snapToSpreadStart(page);
      currentPage = target;
      updateHash(target);
      renderPages(target, spread, viewer, loadingIndicator, isZoomedMain);
      if (fullscreenModal.classList.contains("open")) {
        renderPages(target, fullscreenSpread, fullscreenViewer, fullscreenLoading, isZoomedFullscreen);
      }
      updateProgress();
    };

    const goNext = () => {
      const step = currentStep();
      lastDirection = "forward";
      goToPage(clampPage(currentPage + step));
    };

    const goPrev = () => {
      const step = currentStep();
      lastDirection = "backward";
      goToPage(clampPage(currentPage - step));
    };

    prevButton.addEventListener("click", goPrev);
    nextButton.addEventListener("click", goNext);
    fullscreenPrev.addEventListener("click", goPrev);
    fullscreenNext.addEventListener("click", goNext);

    window.addEventListener("keydown", (event) => {
      if (event.key === "ArrowRight") {
        goNext();
      }
      if (event.key === "ArrowLeft") {
        goPrev();
      }
      if (event.key === "Escape" && fullscreenModal.classList.contains("open")) {
        fullscreenModal.classList.remove("open");
        fullscreenModal.setAttribute("aria-hidden", "true");
      }
    });

    const handleWheel = (event) => {
      if (isMobile()) {
        return;
      }
      const now = Date.now();
      const timeDelta = Math.max(16, now - lastWheelTime);
      const delta = Math.abs(event.deltaX) > Math.abs(event.deltaY)
        ? event.deltaX
        : event.deltaY;
      if (Math.abs(delta) < 10) {
        return;
      }
      event.preventDefault();
      const velocity = Math.abs(delta) / timeDelta;
      const multiplier = velocity > 3.5 ? 2 : 1;
      const step = currentStep();
      const jump = step * multiplier;
      lastWheelTime = now;
      if (delta > 0) {
        lastDirection = "forward";
        goToPage(clampPage(currentPage + jump));
      } else {
        lastDirection = "backward";
        goToPage(clampPage(currentPage - jump));
      }
    };

    spread.addEventListener("wheel", handleWheel, { passive: false });
    fullscreenSpread.addEventListener("wheel", handleWheel, { passive: false });

    window.addEventListener("hashchange", () => {
      goToPage(parseHash());
    });

    mobileQuery.addEventListener("change", () => {
      goToPage(currentPage);
    });

    window.addEventListener("resize", () => {
      updatePageMaxHeight(viewer, spread, isZoomedMain);
      if (fullscreenModal.classList.contains("open")) {
        updatePageMaxHeight(fullscreenViewer, fullscreenSpread, isZoomedFullscreen);
      }
    });

    [progressSlider, fullscreenProgress].forEach((slider) => {
      slider.addEventListener("input", (event) => {
        const nextPage = parseInt(event.target.value, 10);
        lastDirection = nextPage >= currentPage ? "forward" : "backward";
        goToPage(nextPage);
      });
    });

    const toggleZoom = (page, targetSpread) => {
      if (!page) return;
      if (targetSpread === spread) {
        if (!isZoomedMain) {
          isZoomedMain = true;
          currentPage = clampPage(page);
        } else {
          isZoomedMain = false;
        }
      } else {
        if (!isZoomedFullscreen) {
          isZoomedFullscreen = true;
          currentPage = clampPage(page);
        } else {
          isZoomedFullscreen = false;
        }
      }
      updateZoomState();
      goToPage(currentPage);
    };

    [spread, fullscreenSpread].forEach((targetSpread) => {
      targetSpread.addEventListener("click", (event) => {
        const frame = event.target.closest(".page-frame");
        const page = parseInt(frame?.dataset?.page || "", 10);
        if (!Number.isNaN(page)) {
          toggleZoom(page, targetSpread);
        }
      });
    });

    fullscreenButton.addEventListener("click", () => {
      fullscreenModal.classList.add("open");
      fullscreenModal.setAttribute("aria-hidden", "false");
      renderPages(currentPage, fullscreenSpread, fullscreenViewer, fullscreenLoading, isZoomedFullscreen);
      updateProgress();
    });

    fullscreenModal.addEventListener("click", (event) => {
      if (event.target?.dataset?.close === "fullscreen") {
        fullscreenModal.classList.remove("open");
        fullscreenModal.setAttribute("aria-hidden", "true");
      }
    });

    const initialPage = snapToSpreadStart(parseHash());
    currentPage = initialPage;
    updateZoomState();
    renderPages(initialPage, spread, viewer, loadingIndicator, isZoomedMain);
    updateProgress();
  </script>
</body>
</html>
