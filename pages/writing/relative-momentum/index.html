<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Relative Momentum — Jacob Conlon Shields</title>
  <link rel="stylesheet" href="/assets/styles.css" />
  <style>
    .viewer {
      margin-top: 16px;
      display: grid;
      gap: 16px;
      --page-max-height: clamp(260px, 42vh, 520px);
    }

    .viewer-controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      margin-bottom: 4px;
    }

    .viewer-controls .btn {
      min-width: 120px;
      text-align: center;
    }

    .loading-indicator {
      font-size: 0.95rem;
      opacity: 0.8;
      min-height: 1.2em;
    }

    .spread {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 18px;
      align-items: center;
      transition: opacity 220ms ease, transform 220ms ease;
    }

    .spread.turning {
      opacity: 0.2;
      transform: translateX(12px);
    }

    .page-frame {
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(0, 0, 0, 0.2);
      padding: 8px;
      border-radius: 10px;
      min-height: 220px;
      max-height: var(--page-max-height);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .page-frame img {
      width: 100%;
      height: auto;
      max-height: 100%;
      object-fit: contain;
      display: block;
      border-radius: 6px;
    }

    .missing-page {
      font-size: 0.95rem;
      text-align: center;
      opacity: 0.7;
      padding: 12px;
    }

    @media (max-width: 899px) {
      .spread {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <main>
    <p class="nav">
      <a href="/">Home</a>
      <span class="dot">•</span>
      <a href="/pages/writing/">Writing</a>
      <span class="dot">•</span>
      <a href="/contact/">Contact</a>
    </p>

    <hr class="tight-hr">

    <h1>Relative Momentum</h1>
    <p>
      A two-page spread view of the ebook. Use the buttons, arrow keys, or a
      scroll gesture to move through the pages.
    </p>

    <p style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
      <a class="btn"
         href="https://a.co/d/fbTRmg4"
         target="_blank" rel="noopener noreferrer">
        Buy on Amazon
      </a>
    </p>

    <section class="viewer" aria-label="Relative Momentum ebook viewer">
      <div class="viewer-controls">
        <button class="icon-btn" type="button" id="prev-button" aria-label="Previous pages">◀</button>
        <button class="icon-btn" type="button" id="next-button" aria-label="Next pages">▶</button>
      </div>

      <div class="loading-indicator" id="loading-indicator" aria-live="polite"></div>

      <div class="spread" id="spread"></div>
    </section>
  </main>

  <script>
    const TOTAL_PAGES = 112;
    const IMAGE_BASE = "https://pub-7efa5866e0ab41af9e691f0820376dfc.r2.dev/pages/";

    const spread = document.getElementById("spread");
    const loadingIndicator = document.getElementById("loading-indicator");
    const prevButton = document.getElementById("prev-button");
    const nextButton = document.getElementById("next-button");

    const mobileQuery = window.matchMedia("(max-width: 899px)");
    let currentPage = 1;
    let lastWheelTime = 0;

    const clampPage = (page) => Math.min(Math.max(page, 1), TOTAL_PAGES);

    const isMobile = () => mobileQuery.matches;

    const snapToSpreadStart = (page) => {
      if (isMobile()) {
        return clampPage(page);
      }
      const snapped = page % 2 === 0 ? page - 1 : page;
      return clampPage(snapped);
    };

    const updateHash = (page) => {
      const newHash = `#p=${page}`;
      if (window.location.hash !== newHash) {
        window.location.hash = newHash;
      }
    };

    const parseHash = () => {
      const match = window.location.hash.match(/p=(\d+)/);
      if (!match) return 1;
      return clampPage(parseInt(match[1], 10));
    };

    const formatPageNumber = (page) => page.toString().padStart(3, "0");

    const setLoading = (isLoading, message = "Loading pages…") => {
      loadingIndicator.textContent = isLoading ? message : "";
    };

    const preloadNext = (page) => {
      const pagesToLoad = isMobile() ? [page + 1] : [page + 2, page + 3];
      pagesToLoad
        .map(clampPage)
        .filter((p) => p > 0 && p <= TOTAL_PAGES)
        .forEach((p) => {
          const img = new Image();
          img.src = `${IMAGE_BASE}page-${formatPageNumber(p)}.jpg`;
        });
    };

    const createPageFrame = (page) => {
      const frame = document.createElement("div");
      frame.className = "page-frame";

      if (page > TOTAL_PAGES || page < 1) {
        return frame;
      }

      const img = document.createElement("img");
      img.loading = "lazy";
      img.alt = `Relative Momentum page ${page}`;
      img.src = `${IMAGE_BASE}page-${formatPageNumber(page)}.jpg`;

      img.addEventListener("error", () => {
        frame.innerHTML = "";
        const missing = document.createElement("div");
        missing.className = "missing-page";
        missing.textContent = `Page ${page} is unavailable.`;
        frame.appendChild(missing);
      });

      frame.appendChild(img);
      return frame;
    };

    const renderPages = (page) => {
      spread.classList.add("turning");
      setLoading(true);
      spread.innerHTML = "";

      const pages = isMobile() ? [page] : [page, page + 1];
      const frames = pages.map(createPageFrame);
      frames.forEach((frame) => spread.appendChild(frame));

      const images = Array.from(spread.querySelectorAll("img"));
      const onImageDone = () => {
        const allDone = images.every((img) => img.complete);
        if (allDone) {
          setLoading(false);
        }
      };

      if (images.length === 0) {
        setLoading(false, "No pages to display.");
      } else {
        images.forEach((img) => {
          if (img.complete) {
            onImageDone();
          } else {
            img.addEventListener("load", onImageDone, { once: true });
            img.addEventListener("error", onImageDone, { once: true });
          }
        });
      }

      window.setTimeout(() => spread.classList.remove("turning"), 250);
      preloadNext(page);
    };

    const goToPage = (page) => {
      const target = snapToSpreadStart(page);
      currentPage = target;
      updateHash(target);
      renderPages(target);
    };

    const goNext = () => {
      const step = isMobile() ? 1 : 2;
      goToPage(clampPage(currentPage + step));
    };

    const goPrev = () => {
      const step = isMobile() ? 1 : 2;
      goToPage(clampPage(currentPage - step));
    };

    prevButton.addEventListener("click", goPrev);
    nextButton.addEventListener("click", goNext);

    window.addEventListener("keydown", (event) => {
      if (event.key === "ArrowRight") {
        goNext();
      }
      if (event.key === "ArrowLeft") {
        goPrev();
      }
    });

    spread.addEventListener("wheel", (event) => {
      if (isMobile()) {
        return;
      }
      const now = Date.now();
      if (now - lastWheelTime < 400) {
        return;
      }
      const delta = Math.abs(event.deltaX) > Math.abs(event.deltaY)
        ? event.deltaX
        : event.deltaY;
      if (Math.abs(delta) < 12) {
        return;
      }
      event.preventDefault();
      lastWheelTime = now;
      if (delta > 0) {
        goNext();
      } else {
        goPrev();
      }
    }, { passive: false });

    window.addEventListener("hashchange", () => {
      goToPage(parseHash());
    });

    mobileQuery.addEventListener("change", () => {
      goToPage(currentPage);
    });

    const initialPage = snapToSpreadStart(parseHash());
    currentPage = initialPage;
    renderPages(initialPage);
  </script>
</body>
</html>
