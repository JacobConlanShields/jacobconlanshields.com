<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Video Flow Builder</title>
  <link rel="stylesheet" href="/assets/styles.css" />
</head>
<body>
  <main class="flow-page">
    <p class="nav">
      <a href="/">Home</a>
      <span class="dot">•</span>
      <a href="/pages/projects/">Projects</a>
      <span class="dot">•</span>
      <a href="/pages/video-flow/">Video Flow Builder</a>
      <span class="dot">•</span>
      <a href="/pages/podcast/">Podcast</a>
    </p>

    <h1>Video Flow Builder</h1>
    <p class="lede">Import playlists into a video bank, drag any thumbnail to the canvas, then connect nodes with arrows and branches.</p>

    <section class="flow-toolbar" aria-label="Video bank and flow controls">
      <div class="flow-control-row flow-control-row--stack">
        <label for="playlistUrls">YouTube Playlist URLs (one per line)</label>
        <textarea id="playlistUrls" rows="3" placeholder="https://www.youtube.com/playlist?list=...\nhttps://www.youtube.com/playlist?list=..."></textarea>
      </div>
      <div class="flow-control-row">
        <label for="singleVideoUrl">Single YouTube Video URL</label>
        <input id="singleVideoUrl" type="text" placeholder="https://www.youtube.com/watch?v=..." />
        <button id="addVideoToBankBtn" type="button">Add to Video Bank</button>
      </div>
      <div class="flow-actions">
        <button id="loadPlaylistsBtn" type="button">Load Playlist(s) to Video Bank</button>
        <button id="connectModeBtn" type="button" class="ghost">Start Arrow Connect Mode</button>
        <button id="deleteSelectedBtn" type="button" class="ghost" disabled>Delete Selected Node</button>
        <button id="clearCanvasBtn" type="button" class="ghost">Clear Flowchart</button>
      </div>
      <p id="flowStatus" class="status" aria-live="polite">Load a playlist to start building.</p>
    </section>

    <section class="flow-layout" aria-label="Video bank and flowchart workspace">
      <aside class="video-bank" aria-label="Video bank">
        <div class="video-bank__head">
          <h2>Video Bank</h2>
          <p>Drag thumbnails into the flowchart.</p>
        </div>
        <div id="videoBankList" class="video-bank__list"></div>
      </aside>

      <section id="flowCanvas" class="flow-canvas" aria-label="Flowchart canvas" data-drop-zone="true">
        <svg id="edgeLayer" class="flow-edges" aria-hidden="true">
          <defs>
            <marker id="arrowhead" markerWidth="8" markerHeight="8" refX="6" refY="4" orient="auto" markerUnits="strokeWidth">
              <path d="M0,0 L8,4 L0,8 z" fill="rgba(242,242,242,.62)"></path>
            </marker>
          </defs>
        </svg>
        <div class="flow-canvas__hint">Drop videos here</div>
      </section>
    </section>
  </main>

  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-backdrop" data-close-modal="true"></div>
    <div class="modal-card flow-modal-card">
      <button type="button" class="modal-close" id="closeModal" aria-label="Close player">✕</button>
      <h2 id="modalTitle">Video</h2>
      <div class="player-wrap" id="youtubePlayerWrap"></div>
    </div>
  </div>

  <script>
    const state = {
      bankItems: [],
      nodes: [],
      edges: [],
      bankCounter: 0,
      nodeCounter: 0,
      selectedNodeId: null,
      connectMode: false,
      pendingConnectFrom: null
    };

    const flowStatus = document.getElementById('flowStatus');
    const videoBankList = document.getElementById('videoBankList');
    const flowCanvas = document.getElementById('flowCanvas');
    const edgeLayer = document.getElementById('edgeLayer');
    const connectModeBtn = document.getElementById('connectModeBtn');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');

    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const youtubePlayerWrap = document.getElementById('youtubePlayerWrap');

    function status(message) {
      flowStatus.textContent = message;
    }

    function getYouTubeVideoId(url) {
      if (!url) return null;
      try {
        const parsed = new URL(url.trim());
        if (parsed.hostname.includes('youtu.be')) return parsed.pathname.replace('/', '') || null;
        if (parsed.searchParams.get('v')) return parsed.searchParams.get('v');
        const parts = parsed.pathname.split('/').filter(Boolean);
        if (parts[0] === 'shorts' && parts[1]) return parts[1];
      } catch (error) {
        return null;
      }
      return null;
    }

    function getPlaylistId(url) {
      if (!url) return null;
      try {
        return new URL(url.trim()).searchParams.get('list');
      } catch (error) {
        return null;
      }
    }

    function makeBankItem({ title, videoId }) {
      if (!videoId) return null;
      const alreadyExists = state.bankItems.some((item) => item.videoId === videoId);
      if (alreadyExists) return null;

      const item = {
        id: `bank-${++state.bankCounter}`,
        title: title || `Video ${state.bankCounter}`,
        videoId,
        thumbnail: `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`
      };
      state.bankItems.push(item);
      return item;
    }

    function renderVideoBank() {
      videoBankList.innerHTML = '';
      if (!state.bankItems.length) {
        videoBankList.innerHTML = '<p class="video-bank__empty">No videos yet.</p>';
        return;
      }

      for (const item of state.bankItems) {
        const card = document.createElement('article');
        card.className = 'video-bank-card';
        card.draggable = true;
        card.dataset.bankId = item.id;
        card.innerHTML = `
          <img src="${item.thumbnail}" alt="${item.title}" />
          <h3>${item.title}</h3>
          <button type="button" class="video-bank-card__open">Preview</button>
        `;

        card.addEventListener('dragstart', (event) => {
          event.dataTransfer.setData('text/bank-id', item.id);
          event.dataTransfer.effectAllowed = 'copy';
        });

        card.querySelector('.video-bank-card__open').addEventListener('click', () => openVideo(item.title, item.videoId));
        videoBankList.appendChild(card);
      }
    }

    async function loadPlaylistsToBank() {
      const value = document.getElementById('playlistUrls').value.trim();
      if (!value) {
        status('Add at least one playlist URL.');
        return;
      }

      const urls = value.split('\n').map((line) => line.trim()).filter(Boolean);
      if (!urls.length) {
        status('Add valid playlist URLs.');
        return;
      }

      status('Loading playlist videos into the video bank...');
      let addedCount = 0;

      for (const url of urls) {
        const playlistId = getPlaylistId(url);
        if (!playlistId) continue;

        try {
          const feedUrl = `https://www.youtube.com/feeds/videos.xml?playlist_id=${playlistId}`;
          const response = await fetch(`/yt?url=${encodeURIComponent(feedUrl)}`);
          if (!response.ok) continue;

          const xmlText = await response.text();
          const xml = new DOMParser().parseFromString(xmlText, 'application/xml');
          const entries = [...xml.querySelectorAll('entry')];

          for (const entry of entries) {
            const videoId = entry.querySelector('video\\:videoId, videoId')?.textContent?.trim();
            const title = entry.querySelector('title')?.textContent?.trim() || 'Untitled video';
            const added = makeBankItem({ title, videoId });
            if (added) addedCount += 1;
          }
        } catch (error) {
          // continue with next playlist
        }
      }

      renderVideoBank();
      if (!addedCount) {
        status('No new videos were added. If local, use `wrangler pages dev .` so `/yt` works.');
      } else {
        status(`Added ${addedCount} videos to the bank. Drag them into the flowchart.`);
      }
    }

    function addSingleVideoToBank() {
      const input = document.getElementById('singleVideoUrl');
      const videoId = getYouTubeVideoId(input.value);
      if (!videoId) {
        status('Could not parse that YouTube video URL.');
        return;
      }
      const created = makeBankItem({ title: `Video ${state.bankItems.length + 1}`, videoId });
      if (!created) {
        status('That video is already in the bank.');
        return;
      }
      renderVideoBank();
      input.value = '';
      status('Video added to bank. Drag it into the flowchart.');
    }

    function makeNodeFromBankItem(item, x, y) {
      const node = {
        id: `node-${++state.nodeCounter}`,
        title: item.title,
        videoId: item.videoId,
        thumbnail: item.thumbnail,
        x,
        y
      };
      state.nodes.push(node);
      return node;
    }

    function getNodeCenter(node) {
      return { x: node.x + 95, y: node.y + 66 };
    }

    function renderEdges() {
      const width = flowCanvas.scrollWidth;
      const height = flowCanvas.scrollHeight;
      edgeLayer.setAttribute('viewBox', `0 0 ${width} ${height}`);

      edgeLayer.querySelectorAll('.flow-edge').forEach((edge) => edge.remove());
      for (const edge of state.edges) {
        const from = state.nodes.find((node) => node.id === edge.from);
        const to = state.nodes.find((node) => node.id === edge.to);
        if (!from || !to) continue;

        const start = getNodeCenter(from);
        const end = getNodeCenter(to);
        const dx = Math.max(60, Math.abs(end.x - start.x) * 0.35);

        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('class', 'flow-edge');
        path.setAttribute('d', `M ${start.x} ${start.y} C ${start.x + dx} ${start.y}, ${end.x - dx} ${end.y}, ${end.x} ${end.y}`);
        path.setAttribute('marker-end', 'url(#arrowhead)');
        edgeLayer.appendChild(path);
      }
    }

    function selectNode(nodeId) {
      state.selectedNodeId = nodeId;
      deleteSelectedBtn.disabled = !nodeId;

      flowCanvas.querySelectorAll('.flow-node').forEach((el) => {
        el.classList.toggle('is-selected', el.dataset.nodeId === nodeId);
      });
    }

    function handleConnectClick(nodeId) {
      if (!state.connectMode) {
        selectNode(nodeId);
        return;
      }

      if (!state.pendingConnectFrom) {
        state.pendingConnectFrom = nodeId;
        selectNode(nodeId);
        status('Arrow mode: now click the destination node.');
        return;
      }

      if (state.pendingConnectFrom === nodeId) {
        status('Pick a different destination node.');
        return;
      }

      const duplicate = state.edges.some((edge) => edge.from === state.pendingConnectFrom && edge.to === nodeId);
      if (!duplicate) {
        state.edges.push({ from: state.pendingConnectFrom, to: nodeId });
      }

      const fromNode = state.nodes.find((n) => n.id === state.pendingConnectFrom);
      const toNode = state.nodes.find((n) => n.id === nodeId);
      renderEdges();
      state.pendingConnectFrom = null;
      status(`Connected: ${fromNode?.title || 'Node'} → ${toNode?.title || 'Node'}`);
    }

    function createNodeElement(node) {
      const el = document.createElement('article');
      el.className = 'flow-node';
      el.dataset.nodeId = node.id;
      el.style.left = `${node.x}px`;
      el.style.top = `${node.y}px`;
      el.innerHTML = `
        <img src="${node.thumbnail}" alt="${node.title}" />
        <div class="flow-node__meta">
          <span>${node.title}</span>
          <div class="flow-node__actions">
            <button type="button" data-role="open">Open</button>
            <button type="button" data-role="connect">Connect</button>
          </div>
        </div>
      `;

      let dragging = false;
      let offsetX = 0;
      let offsetY = 0;

      el.addEventListener('pointerdown', (event) => {
        if (event.target.tagName === 'BUTTON') return;
        dragging = true;
        offsetX = event.clientX - el.offsetLeft;
        offsetY = event.clientY - el.offsetTop;
        selectNode(node.id);
        el.setPointerCapture(event.pointerId);
      });

      el.addEventListener('pointermove', (event) => {
        if (!dragging) return;
        node.x = Math.max(10, event.clientX - offsetX + flowCanvas.scrollLeft);
        node.y = Math.max(10, event.clientY - offsetY + flowCanvas.scrollTop);
        el.style.left = `${node.x}px`;
        el.style.top = `${node.y}px`;
        renderEdges();
      });

      el.addEventListener('pointerup', (event) => {
        dragging = false;
        if (el.hasPointerCapture(event.pointerId)) {
          el.releasePointerCapture(event.pointerId);
        }
      });

      el.addEventListener('click', () => selectNode(node.id));
      el.querySelector('[data-role="open"]').addEventListener('click', () => openVideo(node.title, node.videoId));
      el.querySelector('[data-role="connect"]').addEventListener('click', () => handleConnectClick(node.id));
      flowCanvas.appendChild(el);
    }

    function addNodeToCanvasFromBank(bankId, dropX, dropY) {
      const bankItem = state.bankItems.find((item) => item.id === bankId);
      if (!bankItem) return;

      const rect = flowCanvas.getBoundingClientRect();
      const x = Math.max(10, dropX - rect.left + flowCanvas.scrollLeft - 90);
      const y = Math.max(10, dropY - rect.top + flowCanvas.scrollTop - 50);
      const node = makeNodeFromBankItem(bankItem, x, y);
      createNodeElement(node);
      selectNode(node.id);
      renderEdges();
      status(`Added "${bankItem.title}" to the flowchart.`);
    }

    function deleteSelectedNode() {
      if (!state.selectedNodeId) return;
      const id = state.selectedNodeId;

      state.nodes = state.nodes.filter((node) => node.id !== id);
      state.edges = state.edges.filter((edge) => edge.from !== id && edge.to !== id);

      flowCanvas.querySelector(`.flow-node[data-node-id="${id}"]`)?.remove();
      state.selectedNodeId = null;
      deleteSelectedBtn.disabled = true;
      renderEdges();
      status('Selected node deleted.');
    }

    function toggleConnectMode() {
      state.connectMode = !state.connectMode;
      state.pendingConnectFrom = null;
      connectModeBtn.textContent = state.connectMode ? 'Stop Arrow Connect Mode' : 'Start Arrow Connect Mode';
      connectModeBtn.classList.toggle('is-active', state.connectMode);
      status(state.connectMode ? 'Arrow mode on: click source node, then destination node.' : 'Arrow mode off.');
    }

    function clearCanvas() {
      state.nodes = [];
      state.edges = [];
      state.selectedNodeId = null;
      state.pendingConnectFrom = null;
      deleteSelectedBtn.disabled = true;
      flowCanvas.querySelectorAll('.flow-node').forEach((node) => node.remove());
      renderEdges();
      status('Flowchart cleared. Video bank preserved.');
    }

    function openVideo(title, videoId) {
      if (!videoId) return;
      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
      modalTitle.textContent = title;
      youtubePlayerWrap.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}" title="${title}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>`;
    }

    function closeVideo() {
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
      youtubePlayerWrap.innerHTML = '';
    }

    flowCanvas.addEventListener('dragover', (event) => {
      event.preventDefault();
      event.dataTransfer.dropEffect = 'copy';
    });

    flowCanvas.addEventListener('drop', (event) => {
      event.preventDefault();
      const bankId = event.dataTransfer.getData('text/bank-id');
      if (!bankId) return;
      addNodeToCanvasFromBank(bankId, event.clientX, event.clientY);
    });

    document.getElementById('loadPlaylistsBtn').addEventListener('click', loadPlaylistsToBank);
    document.getElementById('addVideoToBankBtn').addEventListener('click', addSingleVideoToBank);
    document.getElementById('connectModeBtn').addEventListener('click', toggleConnectMode);
    document.getElementById('deleteSelectedBtn').addEventListener('click', deleteSelectedNode);
    document.getElementById('clearCanvasBtn').addEventListener('click', clearCanvas);

    document.getElementById('closeModal').addEventListener('click', closeVideo);
    modal.addEventListener('click', (event) => {
      if (event.target.matches('[data-close-modal="true"]')) closeVideo();
    });

    window.addEventListener('resize', renderEdges);
    renderVideoBank();
    renderEdges();
  </script>
</body>
</html>
