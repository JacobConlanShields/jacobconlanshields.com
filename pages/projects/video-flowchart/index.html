<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YouTube Flowchart Wireframe — Jacob Conlon Shields</title>
  <link rel="stylesheet" href="/assets/styles.css" />
  <style>
    .flow-layout { display: grid; grid-template-columns: 320px minmax(0, 1fr); gap: 16px; }
    .panel { background: #242424; border: 1px solid rgba(255,255,255,.16); border-radius: 14px; padding: 12px; }
    .panel h2 { margin: 0 0 8px; font-size: 18px; }
    .panel p { margin-bottom: 10px; }
    .stack { display: grid; gap: 8px; }
    input, textarea { width: 100%; background: #111; color: #f2f2f2; border: 1px solid rgba(255,255,255,.18); border-radius: 10px; padding: 10px; font: inherit; }

    .video-bank { max-height: 62vh; overflow: auto; display: grid; gap: 8px; }
    .bank-card { display: grid; grid-template-columns: 108px minmax(0,1fr); gap: 8px; border: 1px solid rgba(255,255,255,.2); border-radius: 12px; background: #1d1d1d; padding: 8px; cursor: grab; }
    .bank-card img { width: 100%; border-radius: 8px; display: block; }
    .bank-card h3 { font-size: 13px; margin: 0; line-height: 1.3; }

    .board-wrap { position: relative; }
    .board { height: 75vh; min-height: 520px; background-image: radial-gradient(rgba(255,255,255,.24) 1px, transparent 1px); background-size: 18px 18px; border: 1px solid rgba(255,255,255,.18); border-radius: 16px; position: relative; overflow: hidden; }
    .board svg { position: absolute; inset: 0; pointer-events: none; }

    .node {
      position: absolute; min-width: 180px; max-width: 280px; background: #d6bdf2; color: #2e1854;
      border: 2px solid #8b44f8; border-radius: 14px; padding: 8px; box-shadow: 0 8px 20px rgba(0,0,0,.25);
    }
    .node.video { background: #b6e5c8; border-color: #005f12; color: #05320e; }
    .node-header { display: flex; align-items: center; justify-content: space-between; gap: 6px; margin-bottom: 6px; }
    .node-handle { font-size: 12px; opacity: .7; }
    .node iframe { width: 100%; aspect-ratio: 16/9; border: 0; border-radius: 8px; }
    .node textarea { min-height: 80px; resize: vertical; background: rgba(255,255,255,.65); color: #2e1854; }

    .toolbar { display: flex; flex-wrap: wrap; gap: 8px; margin: 0 0 10px; }
    .toolbar .btn { font-size: 14px; }
    .help { font-size: 13px; color: rgba(242,242,242,.75); }

    @media (max-width: 960px) {
      .flow-layout { grid-template-columns: 1fr; }
      .board { height: 60vh; }
    }
  </style>
</head>
<body>
  <main>
    <p class="nav">
      <a href="/">Home</a><span class="dot">•</span>
      <a href="/pages/projects/">Projects</a><span class="dot">•</span>
      <a href="/pages/projects/video-flowchart/">YouTube Flowchart</a><span class="dot">•</span>
      <a href="/pages/writing/">Writing</a><span class="dot">•</span>
      <a href="/pages/podcast/">Podcast</a><span class="dot">•</span>
      <a href="/contact/">Contact</a>
    </p>
    <hr class="tight-hr" />

    <h1>YouTube Flowchart Wireframe</h1>
    <p>Build a web of connected video and text ideas by dragging playlist videos onto a whiteboard and linking nodes with arrows.</p>

    <section class="flow-layout">
      <aside class="panel">
        <h2>Video Bank</h2>
        <p>Paste a playlist URL or playlist ID (PL...). Uses <code>/yt?url=...</code> when available.</p>
        <div class="stack">
          <input id="playlistInput" placeholder="https://www.youtube.com/playlist?list=PL..." />
          <button id="loadPlaylist">Load Playlist</button>
          <button id="addTextBox">Add Text Box</button>
        </div>
        <p id="bankStatus" class="help" aria-live="polite"></p>
        <div id="videoBank" class="video-bank"></div>
      </aside>

      <section class="board-wrap">
        <div class="toolbar">
          <button id="connectMode" class="btn">Connect Nodes: Off</button>
          <button id="clearBoard" class="btn">Clear Board</button>
          <span class="help">Drag cards into the board. Move nodes by dragging the ↕ handle.</span>
        </div>
        <div id="board" class="board">
          <svg id="links" aria-hidden="true"></svg>
        </div>
      </section>
    </section>
  </main>

  <script>
    const board = document.getElementById('board');
    const linksSvg = document.getElementById('links');
    const videoBank = document.getElementById('videoBank');
    const bankStatus = document.getElementById('bankStatus');
    const playlistInput = document.getElementById('playlistInput');

    const state = {
      nodes: new Map(),
      edges: [],
      nodeId: 1,
      connectMode: false,
      pendingSource: null,
    };

    function extractPlaylistId(value) {
      if (!value) return '';
      if (/^[A-Za-z0-9_-]{10,}$/.test(value) && value.startsWith('PL')) return value;
      try {
        const url = new URL(value);
        return url.searchParams.get('list') || '';
      } catch {
        const match = value.match(/list=([A-Za-z0-9_-]+)/);
        return match ? match[1] : '';
      }
    }

    async function loadPlaylist() {
      const playlistId = extractPlaylistId(playlistInput.value.trim());
      if (!playlistId) {
        bankStatus.textContent = 'Enter a valid playlist URL or playlist ID.';
        return;
      }
      bankStatus.textContent = 'Loading playlist...';
      videoBank.innerHTML = '';

      const feed = `https://www.youtube.com/feeds/videos.xml?playlist_id=${encodeURIComponent(playlistId)}`;
      const urls = [`/yt?url=${encodeURIComponent(feed)}`, feed];
      let xmlText = '';

      for (const url of urls) {
        try {
          const res = await fetch(url);
          if (!res.ok) continue;
          xmlText = await res.text();
          if (xmlText.includes('<feed')) break;
        } catch (err) {
          // fallback
        }
      }

      if (!xmlText) {
        bankStatus.textContent = 'Could not load playlist feed. If local preview blocks CORS, use Cloudflare Pages with /yt proxy.';
        return;
      }

      const doc = new DOMParser().parseFromString(xmlText, 'application/xml');
      const entries = Array.from(doc.querySelectorAll('entry')).slice(0, 40);
      if (!entries.length) {
        bankStatus.textContent = 'No videos found in this playlist.';
        return;
      }

      entries.forEach((entry) => {
        const title = entry.querySelector('title')?.textContent || 'Untitled';
        const videoId = entry.querySelector('video\\:id, id')?.textContent?.replace('yt:video:', '') || '';
        const thumb = entry.querySelector('media\\:thumbnail')?.getAttribute('url') || `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg`;
        if (!videoId) return;

        const card = document.createElement('article');
        card.className = 'bank-card';
        card.draggable = true;
        card.dataset.videoId = videoId;
        card.dataset.title = title;
        card.innerHTML = `<img src="${thumb}" alt="${title}"><h3>${title}</h3>`;
        card.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('application/json', JSON.stringify({ type: 'video', title, videoId }));
        });
        videoBank.append(card);
      });
      bankStatus.textContent = `Loaded ${videoBank.children.length} videos. Drag one onto the board.`;
    }

    function createNode(type, payload, x = 80, y = 80) {
      const id = `node-${state.nodeId++}`;
      const node = document.createElement('article');
      node.className = `node ${type}`;
      node.style.left = `${x}px`;
      node.style.top = `${y}px`;
      node.dataset.id = id;

      if (type === 'video') {
        node.innerHTML = `
          <div class="node-header"><strong>${payload.title}</strong><span class="node-handle" title="drag">↕ drag</span></div>
          <iframe src="https://www.youtube.com/embed/${payload.videoId}" allowfullscreen title="${payload.title}"></iframe>
        `;
      } else {
        node.innerHTML = `
          <div class="node-header"><strong>Text note</strong><span class="node-handle" title="drag">↕ drag</span></div>
          <textarea placeholder="Add your thought, decision, or action..."></textarea>
        `;
      }

      board.append(node);
      state.nodes.set(id, node);
      makeDraggable(node);

      node.addEventListener('click', () => {
        if (!state.connectMode) return;
        if (!state.pendingSource) {
          state.pendingSource = id;
          node.style.outline = '3px solid #5f8cff';
          return;
        }
        if (state.pendingSource !== id) {
          state.edges.push({ from: state.pendingSource, to: id });
        }
        resetNodeOutline(state.pendingSource);
        state.pendingSource = null;
        drawEdges();
      });

      drawEdges();
    }

    function resetNodeOutline(id) {
      const item = state.nodes.get(id);
      if (item) item.style.outline = 'none';
    }

    function makeDraggable(node) {
      let startX = 0, startY = 0, originLeft = 0, originTop = 0;
      const handle = node.querySelector('.node-handle');
      handle.addEventListener('pointerdown', (e) => {
        e.preventDefault();
        startX = e.clientX;
        startY = e.clientY;
        originLeft = parseFloat(node.style.left);
        originTop = parseFloat(node.style.top);

        const move = (m) => {
          node.style.left = `${originLeft + (m.clientX - startX)}px`;
          node.style.top = `${originTop + (m.clientY - startY)}px`;
          drawEdges();
        };
        const up = () => {
          window.removeEventListener('pointermove', move);
          window.removeEventListener('pointerup', up);
        };
        window.addEventListener('pointermove', move);
        window.addEventListener('pointerup', up);
      });
    }

    function centerPoint(node) {
      const boardRect = board.getBoundingClientRect();
      const rect = node.getBoundingClientRect();
      return { x: rect.left - boardRect.left + rect.width / 2, y: rect.top - boardRect.top + rect.height / 2 };
    }

    function drawEdges() {
      const width = board.clientWidth;
      const height = board.clientHeight;
      linksSvg.setAttribute('width', width);
      linksSvg.setAttribute('height', height);
      linksSvg.innerHTML = '<defs><marker id="arrow" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#005f12"/></marker></defs>';

      state.edges.forEach((edge) => {
        const from = state.nodes.get(edge.from);
        const to = state.nodes.get(edge.to);
        if (!from || !to) return;
        const p1 = centerPoint(from);
        const p2 = centerPoint(to);
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', p1.x);
        line.setAttribute('y1', p1.y);
        line.setAttribute('x2', p2.x);
        line.setAttribute('y2', p2.y);
        line.setAttribute('stroke', '#005f12');
        line.setAttribute('stroke-width', '2.2');
        line.setAttribute('marker-end', 'url(#arrow)');
        linksSvg.append(line);
      });
    }

    board.addEventListener('dragover', (e) => e.preventDefault());
    board.addEventListener('drop', (e) => {
      e.preventDefault();
      const raw = e.dataTransfer.getData('application/json');
      if (!raw) return;
      const payload = JSON.parse(raw);
      const rect = board.getBoundingClientRect();
      createNode('video', payload, e.clientX - rect.left - 120, e.clientY - rect.top - 80);
    });

    document.getElementById('loadPlaylist').addEventListener('click', loadPlaylist);
    document.getElementById('addTextBox').addEventListener('click', () => createNode('text', {}, 120 + Math.random() * 80, 100 + Math.random() * 80));
    document.getElementById('connectMode').addEventListener('click', (e) => {
      state.connectMode = !state.connectMode;
      e.currentTarget.textContent = `Connect Nodes: ${state.connectMode ? 'On' : 'Off'}`;
      if (!state.connectMode && state.pendingSource) {
        resetNodeOutline(state.pendingSource);
        state.pendingSource = null;
      }
    });
    document.getElementById('clearBoard').addEventListener('click', () => {
      state.nodes.forEach((n) => n.remove());
      state.nodes.clear();
      state.edges = [];
      state.pendingSource = null;
      drawEdges();
    });

    window.addEventListener('resize', drawEdges);
  </script>
</body>
</html>
